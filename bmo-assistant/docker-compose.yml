version: '3.8'

services:
  # Ollama - Local LLM server
  ollama:
    image: ollama/ollama:latest
    container_name: bmo-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # Remove GPU settings if you don't have NVIDIA GPU

  # Redis for memory and caching
  redis:
    image: redis:7-alpine
    container_name: bmo-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped

  # AI Service (Ollama LLM)
  ai-service:
    build: ./services/ai-service
    container_name: bmo-ai
    ports:
      - "8001:8001"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:1b}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
      - ollama
    restart: unless-stopped

  # Voice Service (Speech Recognition & TTS)
  voice-service:
    build: ./services/voice-service
    container_name: bmo-voice
    ports:
      - "8002:8002"
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
    volumes:
      - ./credentials.json:/app/credentials.json:ro
    restart: unless-stopped

  # Task Service (App launching & automation)
  task-service:
    build: ./services/task-service
    container_name: bmo-task
    ports:
      - "8003:8003"
    restart: unless-stopped

  # API Gateway
  gateway:
    build: ./services/gateway
    container_name: bmo-gateway
    ports:
      - "8000:8000"
    environment:
      - AI_SERVICE_URL=http://ai-service:8001
      - VOICE_SERVICE_URL=http://voice-service:8002
      - TASK_SERVICE_URL=http://task-service:8003
    depends_on:
      - ai-service
      - voice-service
      - task-service
    restart: unless-stopped

  # Web Frontend
  web:
    build: ./frontend/web
    container_name: bmo-web
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    depends_on:
      - gateway
    restart: unless-stopped

volumes:
  ollama_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: bmo-network
